<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloomberg Source Extractor</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; color: #333; }
        h1 { font-size: 1.2rem; color: #555; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 12px; margin-bottom: 10px; box-sizing: border-box; }
        button { background-color: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; width: 100%; }
        button:hover { background-color: #333; }
        #output { margin-top: 30px; background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); white-space: pre-wrap; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.1rem; line-height: 1.6; display: none; }
        .error { color: red; font-weight: bold; margin-top: 10px; font-family: monospace; text-transform: uppercase; }
        .divider { border-top: 1px solid #ddd; margin: 20px 0; }
        .caption { font-size: 0.9rem; color: #666; font-style: italic; margin-top: 5px; display: block; }
    </style>
</head>
<body>

    <h1>Bloomberg Source Extractor</h1>
    <textarea id="sourceInput" placeholder="Paste all content in 'view-source:' here..."></textarea>
    <button onclick="processHTML()">Extract Article</button>
    <div id="status" class="error"></div>
    <div id="output"></div>

    <script>
        function processHTML() {
            const html = document.getElementById('sourceInput').value;
            const statusDiv = document.getElementById('status');
            const outputDiv = document.getElementById('output');
            
            statusDiv.innerText = "";
            outputDiv.style.display = 'none';
            outputDiv.innerText = "";

            if (!html) {
                statusDiv.innerText = "PLEASE PASTE SOURCE CODE FIRST.";
                return;
            }

            try {
                const text = extractBloomberg(html);
                outputDiv.innerText = text;
                outputDiv.style.display = 'block';
            } catch (e) {
                statusDiv.innerText = "EXTRACTION FAILED: " + e.message;
            }
        }

        function extractBloomberg(htmlSource) {
            let jsonStr = "";
            
            // 1. Locate the Next.js data script
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlSource, "text/html");
            const script = doc.getElementById("__NEXT_DATA__");

            if (script) {
                jsonStr = script.innerHTML;
            } else {
                throw new Error("CANNOT FIND '__NEXT_DATA__' SCRIPT. SOURCE CODE MAY BE INCOMPLETE OR FROM AN UNSUPPORTED PAGE.");
            }

            // 2. Parse JSON
            let data;
            try {
                data = JSON.parse(jsonStr);
            } catch (e) {
                throw new Error("JSON PARSING FAILED.");
            }

            // 3. Navigate the JSON structure
            // Bloomberg structure: props -> pageProps -> story -> body -> content
            const story = data?.props?.pageProps?.story;
            
            if (!story) {
                throw new Error("CANNOT FIND STORY DATA IN JSON.");
            }

            let output = [];

            // --- Header Info ---
            output.push("Bloomberg");
            output.push("");
            output.push(story.headline || "");
            
            // Summary / Dek
            // Bloomberg sometimes puts summary in 'summary' field or first paragraph of body
            if (story.summary && typeof story.summary === 'string') {
                 output.push(story.summary);
            } else if (story.summaryHtml) {
                 // Simple strip tags if HTML summary exists
                 output.push(story.summaryHtml.replace(/<[^>]*>?/gm, ''));
            }
            output.push("");

            // Authors
            if (story.authors && Array.isArray(story.authors)) {
                const authors = story.authors.map(a => a.name).join(", ");
                output.push("By " + authors);
            } else if (story.byline) {
                output.push("By " + story.byline);
            }

            // Date
            if (story.publishedAt) {
                output.push(formatDate(story.publishedAt));
            }
            output.push("");
            output.push("------------------------------------------------");
            output.push("");

            // --- Body Content ---
            const bodyContent = story.body?.content || [];

            bodyContent.forEach(block => {
                const type = block.type;
                
                // Paragraphs
                if (type === "paragraph") {
                    const text = block.content.map(item => item.value || "").join("");
                    if (text.trim()) {
                        output.push(text);
                        output.push("");
                    }
                } 
                // Headings
                else if (type === "heading") {
                    const text = block.content.map(item => item.value || "").join("");
                    if (text.trim()) {
                        output.push("");
                        output.push(text.toUpperCase());
                        output.push("");
                    }
                }
                // Images
                else if (type === "media" && block.subType === "photo") {
                    const caption = block.photo?.caption || block.data?.photo?.caption || "";
                    if (caption) {
                        output.push(`[Image Caption: ${caption}]`);
                        output.push("");
                    }
                }
                // Lists (Bullet points)
                else if (type === "list") {
                    const items = block.content || [];
                    items.forEach(li => {
                         const liText = li.content.map(i => i.value || "").join("");
                         if(liText) output.push("â€¢ " + liText);
                    });
                    output.push("");
                }
            });

            // Footer / URL
            output.push("");
            output.push("Original URL: " + (story.url || ""));

            return output.join("\n");
        }

        function formatDate(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleString('en-US', { 
                    year: 'numeric', month: 'long', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', timeZoneName: 'short' 
                });
            } catch (e) {
                return isoString;
            }
        }
    </script>
</body>
</html>
